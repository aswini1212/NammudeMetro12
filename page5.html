<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>page5</title>
    <link
    rel="stylesheet";
    href="./page5.css";
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Calistoga&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bubbler+One&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Bungee+Shade&display=swap" rel="stylesheet">
</head>
<body>
    <div class="inner">
        <h3 class="nammude1">nammude</h3>
        <h3 class="ticket">TICKET</h3>

        <h4 id="id">Id</h4>
        <input type="text" class="first" value="" disabled>

        <h4 id="from">From</h4>
        <input type="text" class="second" value="" disabled>

        <h4 id="to">To</h4>
        <input type="text" class="third" value="" disabled>

        <h4 id="fare">Fare</h4>
        <input type="text" class="fourth" value="" disabled>

        <div class="ok" id="print">
            <h3 id="okbtn">PRINT</h3>
        </div>

        <div class="home"></div>
            <a href="./index.html" style="text-decoration: none;">
                <h3 id="hmebtn">HOME</h3>
            </a>
        </div>
    </div>

    <footer>
        <p><span class="nammude">nammude</span><br><span class="metro">METRO</span></p>
    </footer>

    <div id="one"></div>
    <div id="two"></div>
    <div id="three"></div>
    <div id="four"></div>
    <div id="five"></div>
    <div id="six"></div>
    <div id="seven"></div>
    <div id="eight"></div>
    <div id="nine"></div>
    <div id="ten"></div>
    <div id="eleven"></div>
    <div id="twelve"></div>
    <div id="thirteen"></div>
    <div id="fourteen"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" crossorigin="anonymous">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://owimaafcnxffuupkgcej.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93aW1hYWZjbnhmZnV1cGtnY2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjg4MjEwNzQsImV4cCI6MjA0NDM5NzA3NH0.cv3cnv77GJ--TZQPrhA4wNnfwSfR3W1QrWCyLl2u88I';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        async function fetchFareDetailsAndInsertTicket() {
            // Fetching from local storage for 'from' and 'to'
            const from = localStorage.getItem('from');
            const to = localStorage.getItem('to');
            
            try {
                // Querying Supabase to fetch Fares based on 'from' and 'to' (start and end destinations)
                const { data, error } = await supabase
                    .from('Fares')
                    .select('F_id, Start_des, End_des, Price')
                    .eq('Start_des', from)
                    .eq('End_des', to)
                    .limit(1);  // Limiting the result to one record

                if (error) {
                    console.error('Error fetching fare data:', error);
                    return;
                }

                // If data is available, populate the fields and insert the ticket
                if (data && data.length > 0) {
                    const fareDetails = data[0];
                    document.querySelector('.first').value = fareDetails.F_id;
                    document.querySelector('.second').value = fareDetails.Start_des;
                    document.querySelector('.third').value = fareDetails.End_des;
                    document.querySelector('.fourth').value = fareDetails.Price;

                    // Insert the fare ID into the Tickets table
                    await insertTicket(fareDetails.F_id);
                } else {
                    console.log('No fare data found for the given route.');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Function to insert ticket into the Tickets table
        async function insertTicket(fareId) {
            try {
                const { data, error } = await supabase
                    .from('Tickets')
                    .insert([
                        { "Fare_id": fareId } // Insert Fare_id into Tickets table
                    ]);

                if (error) {
                    console.error('Error inserting ticket:', error);
                } else {
                    console.log('Ticket inserted successfully:', data);
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Call the function to fetch fare details and insert ticket on page load
        fetchFareDetailsAndInsertTicket();

        document.getElementById('print').addEventListener('click', function () {
            // Fetch values from the input fields
            const ticketId = document.querySelector('.first').value;
            const from = document.querySelector('.second').value;
            const to = document.querySelector('.third').value;
            const fare = document.querySelector('.fourth').value;

            // Get the current date and time
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();

            // Content to be added to the PDF
            const ticketDetails = `Ticket ID: ${ticketId}\nFrom: ${from}\nTo: ${to}\nFare: ${fare}\nDate: ${date}\nTime: ${time}`;

            // Create a new jsPDF instance
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add ticket details to the PDF
            doc.text(ticketDetails, 10, 10);

            // Generate QR code for ticket details
            const qr = qrcode(4, 'L');
            qr.addData(ticketDetails);  // Add ticket details to the QR code
            qr.make();

            // Add the QR code to the PDF as an image
            const qrCodeImage = qr.createDataURL();
            doc.addImage(qrCodeImage, 'PNG', 150, 50, 40, 40);  // Position QR code on the PDF

            // Save the generated PDF
            doc.save('ticket.pdf');
        });
    </script>
</body>
</html>
