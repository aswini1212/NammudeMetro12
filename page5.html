<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>page5</title>
    <link rel="stylesheet" href="./page5.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="inner">
        <h3 class="nammude1">nammude</h3>
        <h3 class="ticket">TICKET</h3>

        <h4 id="id">Id</h4>
        <input type="text" class="first" value="" disabled>

        <h4 id="from">From</h4>
        <input type="text" class="second" value="" disabled>

        <h4 id="to">To</h4>
        <input type="text" class="third" value="" disabled>

        <h4 id="fare">Fare</h4>
        <input type="text" class="fourth" value="" disabled>

        <div class="ok" id="print">
            <h3 id="okbtn">PRINT</h3>
        </div>

        <div class="home">
            <a href="./index.html" style="text-decoration: none;">
                <h3 id="hmebtn">HOME</h3>
            </a>
        </div>
    </div>

    <footer>
        <p><span class="nammude">nammude</span><br><span class="metro">METRO</span></p>
    </footer>

    <div id="qrcode"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script type="module" crossorigin="anonymous">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://owimaafcnxffuupkgcej.supabase.co';
        const supabaseAnonKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        async function fetchFareDetailsAndInsertTicket() {
            const from = localStorage.getItem('from');
            const to = localStorage.getItem('to');
            
            try {
                const { data, error } = await supabase
                    .from('Fares')
                    .select('F_id, Start_des, End_des, Price')
                    .eq('Start_des', from)
                    .eq('End_des', to)
                    .limit(1);

                if (error) {
                    console.error('Error fetching fare data:', error);
                    return;
                }

                if (data && data.length > 0) {
                    const fareDetails = data[0];
                    document.querySelector('.first').value = fareDetails.F_id;
                    document.querySelector('.second').value = fareDetails.Start_des;
                    document.querySelector('.third').value = fareDetails.End_des;
                    document.querySelector('.fourth').value = fareDetails.Price;

                    await insertTicket(fareDetails.F_id);
                } else {
                    console.log('No fare data found for the given route.');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        async function insertTicket(fareId) {
            try {
                const { data, error } = await supabase
                    .from('Tickets')
                    .insert([ { "Fare_id": fareId } ]);

                if (error) {
                    console.error('Error inserting ticket:', error);
                } else {
                    console.log('Ticket inserted successfully:', data);
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        fetchFareDetailsAndInsertTicket();

        // Print PDF with QR code and Ticket Details
        document.getElementById('print').addEventListener('click', function () {
            const from = document.querySelector('.second').value;
            const to = document.querySelector('.third').value;
            const fare = document.querySelector('.fourth').value;
            const ticketId = document.querySelector('.first').value;
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();

            // Create a new jsPDF instance
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add ticket details to PDF (maintaining existing fonts and styles)
            doc.setFont("Roboto", "bold");
            doc.setFontSize(16);
            doc.text("Nammude Metro Ticket", 105, 20, null, null, 'center');

            doc.setFont("Roboto", "normal");
            doc.setFontSize(12);
            doc.text(`Ticket ID: ${ticketId}`, 20, 40);
            doc.text(`From: ${from}`, 20, 50);
            doc.text(`To: ${to}`, 20, 60);
            doc.text(`Fare: ${fare}`, 20, 70);
            doc.text(`Date: ${date}`, 20, 80);
            doc.text(`Time: ${time}`, 20, 90);

            // Generate and Add QR code to PDF
            const qr = qrcode(4, 'L');
            qr.addData(`Ticket ID: ${ticketId}\nFrom: ${from}\nTo: ${to}\nFare: ${fare}`);
            qr.make();

            const qrCodeImage = qr.createDataURL();
            doc.addImage(qrCodeImage, 'PNG', 150, 50, 40, 40);  // Place QR code in the PDF

            // Save the generated PDF
            doc.save('ticket.pdf');
        });
    </script>
</body>
</html>
